{{- if .Values.db.use_operator }}
apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: {{ include "clusterName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "labels" $ | nindent 4 }}
    {{- if .Values.db.operator_install.exporter.enabled }}
    exporter: "true"
    {{- end }}
  {{- if .Values.db.operator_install.controller }}
  annotations:
    acid.zalan.do/controller: {{ .Values.db.operator_install.controller }}
  {{- end }}
spec:
  teamId: {{ .Values.db.operator_install.teamId }}
  volume: {{ toYaml .Values.db.operator_install.dbVolume | nindent 4 }}
  numberOfInstances: {{ .Values.replicas.db }}
  users:
    etrip: []
  databases:
    etrip: etrip
  postgresql:
    version: "11" # postgres >12 does not support OIDs
    parameters: {{ toYaml .Values.db.operator_install.dbParameters | nindent 6}}
  {{- with .Values.db.operator_install.resources }}
  resources: {{ toYaml . | nindent 4 }}
  {{- end }}
  {{- with .Values.db.operator_install.clone }}
  {{- if not .namespace }}
  clone: {{ toYaml . | nindent 4 }}
  {{- else }}
  clone:
    cluster: {{ $.Release.Name }}-source
  {{- end }}
  {{- end }}
  {{- with .Values.db.operator_install.standby }}
  {{- if .enabled }}
  standby:
    s3_wal_path: s3://{{ .bucket }}/spilo/{{ .name | default (include "clusterName" $) }}/{{ .uid }}/wal/11
  {{- end }}
  {{- end }}
  {{- if .Values.db.operator_install.exporter.enabled }}
  sidecars:
  - name: exporter
    image: {{ .Values.db.operator_install.exporter.image }}
    ports:
    - name: http-prom
      containerPort: 9187
      protocol: TCP
    env:
    - name: DATA_SOURCE_NAME
      value: postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@localhost/postgres
  {{- if len .Values.db.operator_install.exporter.extraQueries }}
    - name: PG_EXPORTER_EXTEND_QUERY_PATH
      value: /queries.yaml
  additionalVolumes:
  - name: queries
    mountPath: /queries.yaml
    subPath: queries.yaml
    volumeSource:
      name: queries
      configMap:
        name: {{ include "clusterName" . }}-queries
    targetContainers:
    - exporter
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "clusterName" . }}-queries
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "labels" $ | nindent 4 }}
data:
  queries.yaml: |
    {{- toYaml .Values.db.operator_install.exporter.extraQueries | nindent 4 }}
  {{- end }}
  {{- end }}
{{- if and .Values.db.operator_install.clone .Values.db.operator_install.refresh }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Release.Name }}-refresh-sa
  namespace: {{ .Release.Namespace }}
  labels: 
    {{- include "labels" $ | nindent 4 }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ .Release.Name }}-refresh-role
  namespace: {{ .Release.Namespace }}
  labels: 
    {{- include "labels" $ | nindent 4 }}
rules:
- apiGroups: [ acid.zalan.do ]
  resources: [ postgresqls ]
  resourceNames: [ {{ include "clusterName" . }} ]
  verbs: [ get, delete ]
- apiGroups: [ acid.zalan.do ]
  resources: [ postgresqls ]
  verbs: [ create ]
- apiGroups: [ apps ]
  resources: [ deployments ]
  resourceNames: [ {{ .Release.Name }}-web ]
  verbs: [ get, patch ]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ .Release.Name }}-refresh-rolebinding
  namespace: {{ .Release.Namespace }}
  labels: 
    {{- include "labels" $ | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ .Release.Name }}-refresh-role
subjects:
- kind: ServiceAccount
  name: {{ .Release.Name }}-refresh-sa
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: {{ .Release.Name }}-refresh-db
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "labels" $ | nindent 4 }}
spec:
  schedule: {{ .Values.db.operator_install.refresh }}
  concurrencyPolicy: Forbid
  jobTemplate:
    metadata:
      labels:
        cronjob-name: refresh-db
        {{- include "labels" . | nindent 8 }}
    spec:
      template:
        metadata:
          labels:
            cronjob-name: refresh-db
            {{- include "labels" . | nindent 12 }}
        spec:
          restartPolicy: Never
          serviceAccountName: {{ .Release.Name }}-refresh-sa
          containers:
          - name: kubectl
            command: [ /bin/sh ]
            args:
            - -c
            - |
              kubectl get postgresql $ETRIP_CLUSTER -o yaml > /tmp/temp.yaml
              kubectl delete -f /tmp/temp.yaml
              sleep 5
              kubectl create -f /tmp/temp.yaml
              sleep 5
              while [ "$(kubectl get -f /tmp/temp.yaml -o jsonpath='{.status.PostgresClusterStatus}')" != 'Running' ]; do
                echo "Waiting for ready state"
                sleep 5
              done
              kubectl rollout restart deploy/${ETRIP_RELEASE}-web
            image: bitnami/kubectl
            env:
            - name: ETRIP_RELEASE
              value: {{ .Release.Name }}
            - name: ETRIP_CLUSTER
              value: {{ include "clusterName" . }}
{{- end }}
{{- if .Values.db.operator_install.clone }}
{{- if .Values.db.operator_install.clone.namespace }}
---
apiVersion: v1
kind: Secret
metadata:
  {{- $clusterName := include "clusterName" . }}
  name: standby.{{ .Release.Name }}-source.credentials
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "labels" . | nindent 4 }}
  annotations:
    reflector.v1.k8s.emberstack.com/reflects: "{{- .Values.db.operator_install.clone.namespace -}} /standby.
      {{- .Values.db.operator_install.clone.cluster | default $clusterName -}} .credentials"
type: Opaque
---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-source
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "labels" . | nindent 4 }}
spec:
  type: ExternalName
  externalName: {{.Values.db.operator_install.clone.cluster | default $clusterName -}} .
    {{- .Values.db.operator_install.clone.namespace -}} .svc.cluster.local
  ports:
  - name: postgres
    port: 5432
    protocol: TCP
    targetPort: 5432
{{- end }}
{{- end }}
{{- end }}
